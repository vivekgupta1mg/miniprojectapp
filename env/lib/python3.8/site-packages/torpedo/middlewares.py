import uuid

import aiotask_context as context

from .clients import apm_client


async def handle_request_id(request):
    context.set('X-REQUEST-ID', request.headers.get('X-REQUEST-ID') or str(uuid.uuid4()))
    context.set('X-USER-AGENT', request.headers.get('user-agent'))


async def handle_apm_request(request):
    apm_client.begin_transaction('request')


async def handle_apm_response(request, response):
    path = request.uri_template if hasattr(request, 'uri_template') else 'undefined'
    transaction_name = "{} {}".format(request.method, path)
    apm_client.end_transaction(transaction_name, response.status)
